<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Recovery Urgenze - Pipeline Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --pastel-primary: #B8D4E3;
            --pastel-secondary: #F2D7D9;
            --pastel-accent: #D4E7C5;
            --pastel-warm: #FFE5B4;
            --pastel-cool: #E0BBE4;
            
            --status-nuovo: #A8D5E5;
            --status-non-risponde: #FFD9A0;
            --status-non-risponde-2: #FFCAB0;
            --status-non-risponde-3: #FFB6A3;
            --status-mai-reperibile: #D3D3D3;
            --status-non-interessato: #F4BFBF;
            --status-lead-ok: #B5E7A0;
            
            --text-dark: #4A4A4A;
            --text-medium: #6B6B6B;
            --text-light: #8B8B8B;
            --bg-light: #FAFAFA;
            --border-light: #E8E8E8;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #E8D5E0, #D5E8E0, #E0E8D5);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* SVG Icon Styles */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }
        
        .icon-sm {
            width: 16px;
            height: 16px;
        }
        
        .icon-lg {
            width: 28px;
            height: 28px;
        }
        
        .icon-xl {
            width: 48px;
            height: 48px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            text-align: center;
            position: relative;
            border: 1px solid var(--border-light);
        }
        
        .header h1 {
            color: var(--text-dark);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .header h2 {
            color: var(--text-medium);
            font-weight: 400;
            font-size: 1.1em;
            margin-top: 8px;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .sync-online {
            background: #E8F5E9;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }

        .sync-offline {
            background: #FFEBEE;
            color: #C62828;
            border: 1px solid #FFCDD2;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 16px;
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid var(--border-light);
        }

        .tab {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
            color: var(--text-medium);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .tab:hover {
            background: var(--bg-light);
        }

        .tab.active {
            background: linear-gradient(135deg, var(--pastel-primary), var(--pastel-cool));
            color: var(--text-dark);
            box-shadow: 0 4px 15px rgba(184, 212, 227, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .today-stats {
            background: linear-gradient(135deg, #E8EAF6, #F3E5F5);
            color: var(--text-dark);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        .today-stats h3 {
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .today-stats p {
            margin-top: 10px;
            color: var(--text-medium);
            font-size: 0.9em;
        }

        /* Pipeline Styles */
        .pipeline-container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-bottom: 30px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .pipeline-column {
            background: white;
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            min-width: 200px;
            max-width: 220px;
            height: 600px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .column-header {
            text-align: center;
            padding: 14px 10px;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 12px;
            position: relative;
            font-size: 0.9em;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .column-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        .column-content::-webkit-scrollbar {
            width: 5px;
        }

        .column-content::-webkit-scrollbar-track {
            background: #f5f5f5;
            border-radius: 3px;
        }

        .column-content::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .column-content::-webkit-scrollbar-thumb:hover {
            background: #ccc;
        }

        .pipeline-lead {
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
        }

        .pipeline-lead:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            border-color: var(--pastel-primary);
        }

        .pipeline-lead:active {
            cursor: grabbing;
        }

        .pipeline-lead.dragging {
            opacity: 0.7;
            transform: rotate(2deg) scale(1.02);
            cursor: grabbing;
            z-index: 1000;
        }

        .pipeline-column.drag-over {
            background: #F0F7FF;
            border: 2px dashed var(--pastel-primary);
            transform: scale(1.01);
        }

        .lead-name {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--text-dark);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .lead-email {
            font-size: 0.8em;
            color: var(--text-medium);
            margin-bottom: 4px;
            word-break: break-all;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lead-commercial {
            font-size: 0.8em;
            color: #E67E22;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lead-notes {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 0.8em;
            resize: none;
            min-height: 50px;
            max-height: 70px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .lead-notes:focus {
            outline: none;
            border-color: var(--pastel-primary);
        }

        /* Status Colors - Pastel */
        .nuovo .column-header { background: var(--status-nuovo); }
        .non-risponde .column-header { background: var(--status-non-risponde); }
        .non-risponde-2 .column-header { background: var(--status-non-risponde-2); }
        .non-risponde-3 .column-header { background: var(--status-non-risponde-3); }
        .mai-reperibile .column-header { background: var(--status-mai-reperibile); }
        .non-interessato .column-header { background: var(--status-non-interessato); }
        .lead-ok .column-header { background: var(--status-lead-ok); }

        .column-header .count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            color: var(--text-dark);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid var(--border-light);
        }

        .auto-log {
            background: #FFF9E6;
            border: 1px solid #FFE082;
            border-radius: 6px;
            padding: 6px 8px;
            margin-top: 8px;
            font-size: 0.7em;
            color: #8D6E00;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .lead-timestamp {
            font-size: 0.75em;
            color: var(--text-light);
            border-top: 1px solid var(--border-light);
            padding-top: 8px;
            margin-top: 8px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            margin: 4% auto;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            border: 1px solid var(--border-light);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-light);
        }
        
        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-light);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: var(--text-dark);
            background: var(--bg-light);
        }

        .timeline {
            margin-top: 20px;
        }

        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--bg-light);
            border-radius: 12px;
            border-left: 4px solid var(--pastel-primary);
        }

        .timeline-time {
            font-size: 0.85em;
            color: var(--text-medium);
            min-width: 120px;
        }

        .timeline-content {
            flex: 1;
            margin-left: 15px;
        }

        .timeline-action {
            font-weight: 600;
            color: var(--text-dark);
        }

        /* List View Styles */
        .lead-list {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid var(--border-light);
        }
        
        .lead-list h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--pastel-primary);
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-dark);
        }

        .filter-btn.active {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .filter-btn.nuovo { background: var(--status-nuovo); }
        .filter-btn.non-risponde { background: var(--status-non-risponde); }
        .filter-btn.non-risponde-2 { background: var(--status-non-risponde-2); }
        .filter-btn.non-risponde-3 { background: var(--status-non-risponde-3); }
        .filter-btn.mai-reperibile { background: var(--status-mai-reperibile); }
        .filter-btn.non-interessato { background: var(--status-non-interessato); }
        .filter-btn.lead-ok { background: var(--status-lead-ok); }
        .filter-btn.tutti { background: #E0E0E0; }

        /* Form Styles */
        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--pastel-primary);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--pastel-primary), #9EC5D6);
            color: var(--text-dark);
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(184, 212, 227, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--status-lead-ok), #9BD68C);
            color: var(--text-dark);
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            font-size: 14px;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(181, 231, 160, 0.4);
        }

        /* Import Styles */
        .import-area {
            border: 2px dashed var(--border-light);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 25px;
            background: var(--bg-light);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .import-area:hover {
            border-color: var(--pastel-primary);
            background: #F8FCFF;
        }

        .import-area.dragover {
            border-color: var(--status-lead-ok);
            background: #F5FFF5;
        }

        .file-input {
            display: none;
        }

        .report-section {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid var(--border-light);
        }
        
        .report-section h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .success-message {
            background: #E8F5E9;
            color: #2E7D32;
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #C8E6C9;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .error-message {
            background: #FFEBEE;
            color: #C62828;
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 1px solid #FFCDD2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* KPI Cards */
        .kpi-card {
            padding: 25px;
            border-radius: 16px;
            text-align: center;
            color: var(--text-dark);
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .kpi-card .value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .kpi-card .label {
            font-size: 0.9em;
            opacity: 0.9;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        @media (max-width: 768px) {
            .pipeline-container {
                grid-template-columns: repeat(7, 180px);
                overflow-x: auto;
                padding: 0 10px;
            }
            
            .pipeline-column {
                min-width: 180px;
                max-width: 180px;
                height: 500px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                justify-content: center;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
        }

        .loading.show {
            display: block;
        }
        
        .loading h3 {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: var(--text-dark);
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="sync-status" id="sync-status">
                <svg class="icon-sm spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
                Connessione...
            </div>
            <h1>
                <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="#E57373" stroke-width="2">
                    <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                Lead Recovery Urgenze
            </h1>
            <h2>Dashboard Pipeline - Sistema Condiviso Real-Time</h2>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <h3>
                <svg class="icon spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
                Sincronizzazione in corso...
            </h3>
            <p style="color: var(--text-medium); margin-top: 10px;">Caricamento dati dal cloud...</p>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('pipeline')">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 4h6v6H4zM14 4h6v6h-6zM4 14h6v6H4zM14 14h6v6h-6z"/>
                </svg>
                Pipeline
            </button>
            <button class="tab" onclick="showTab('dashboard')">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                Lista Lead
            </button>
            <button class="tab" onclick="showTab('import')">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                </svg>
                Import Lead
            </button>
            <button class="tab" onclick="showTab('reports')">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Report
            </button>
        </div>

        <!-- Pipeline Tab -->
        <div id="pipeline-tab" class="tab-content active">
            <!-- Today Stats -->
            <div class="today-stats">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    OGGI: <span id="today-calls">0</span> chiamate fatte | <span id="today-ok">0</span> Lead Ok | <span id="today-closed">0</span> Chiusi
                </h3>
                <p>
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <strong>Trascina i lead</strong> tra le colonne per cambiare stato - il sistema registra automaticamente orario e data!
                </p>
            </div>

            <!-- Pipeline Columns -->
            <div class="pipeline-container" id="pipeline-container">
                <!-- Columns will be generated by JavaScript -->
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="lead-list">
                <h3>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Lista Lead Completa
                </h3>
                
                <input type="text" class="search-box" placeholder="Cerca per nome, email o commerciale..." id="search-input">
                
                <div class="filter-buttons">
                    <button class="filter-btn tutti active" onclick="filterLeads('tutti')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        Tutti
                    </button>
                    <button class="filter-btn nuovo" onclick="filterLeads('nuovo')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Nuovo
                    </button>
                    <button class="filter-btn non-risponde" onclick="filterLeads('non-risponde')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        Non risponde
                    </button>
                    <button class="filter-btn non-risponde-2" onclick="filterLeads('non-risponde-2')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        Non risponde 2
                    </button>
                    <button class="filter-btn non-risponde-3" onclick="filterLeads('non-risponde-3')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        Non risponde 3
                    </button>
                    <button class="filter-btn mai-reperibile" onclick="filterLeads('mai-reperibile')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                        </svg>
                        Mai reperibile
                    </button>
                    <button class="filter-btn non-interessato" onclick="filterLeads('non-interessato')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            <path d="M4 4l16 16"/>
                        </svg>
                        Non interessato
                    </button>
                    <button class="filter-btn lead-ok" onclick="filterLeads('lead-ok')">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Lead Ok
                    </button>
                </div>

                <!-- Lead Items -->
                <div id="leads-container">
                    <!-- Lead items will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Import Tab -->
        <div id="import-tab" class="tab-content">
            <div class="report-section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                    </svg>
                    Import Massivo Lead
                </h2>
                <p style="margin-bottom: 20px; color: var(--text-medium);">Carica i tuoi lead da file CSV o Excel. Il sistema riconoscerà automaticamente le colonne: Nome, Cognome, Telefono, Email.</p>
                
                <div id="import-messages"></div>

                <div class="import-area" id="import-area" onclick="document.getElementById('file-input').click()">
                    <svg class="icon-xl" viewBox="0 0 24 24" fill="none" stroke="var(--pastel-primary)" stroke-width="1.5" style="margin-bottom: 15px;">
                        <path d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    <h3 style="color: var(--text-dark); margin-bottom: 10px;">Trascina qui il tuo file o clicca per selezionare</h3>
                    <p style="color: var(--text-medium);">Supportati: CSV, XLSX, XLS</p>
                    <p style="color: var(--text-light); font-size: 0.9em; margin-top: 10px;">
                        Formato atteso: Nome | Cognome | Telefono | Email<br>
                        (le colonne verranno riconosciute automaticamente)
                    </p>
                    <input type="file" id="file-input" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                </div>

                <div id="preview-container" style="display: none;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        Anteprima Dati
                    </h3>
                    <div id="preview-table" style="margin: 15px 0;"></div>
                    <button class="btn-primary" onclick="confirmImport()">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                        </svg>
                        Conferma Import
                    </button>
                    <button class="btn-primary" onclick="cancelImport()" style="background: linear-gradient(135deg, var(--status-non-interessato), #E5A5A5); margin-top: 10px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Annulla
                    </button>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Aggiungi Singolo Lead
                    </h3>
                    <form id="add-lead-form">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="nome" required>
                        </div>
                        <div class="form-group">
                            <label>Cognome</label>
                            <input type="text" id="cognome" required>
                        </div>
                        <div class="form-group">
                            <label>Telefono</label>
                            <input type="tel" id="telefono" required>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="email" required>
                        </div>
                        <button type="submit" class="btn-primary">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            Aggiungi Lead
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports-tab" class="tab-content">
            <div class="report-section">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Dashboard Report Completo
                </h2>
                <p style="margin-bottom: 25px; color: var(--text-medium);">Monitoraggio performance e attività con metriche avanzate.</p>
                
                <!-- KPI Dashboard -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div class="kpi-card" style="background: linear-gradient(135deg, #E8EAF6, #C5CAE9);">
                        <div class="value" id="total-leads">0</div>
                        <div class="label">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            Lead Totali
                        </div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9);">
                        <div class="value" id="recovery-rate-percent">0%</div>
                        <div class="label">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Tasso Recupero
                        </div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2);">
                        <div class="value" id="avg-daily-calls">0</div>
                        <div class="label">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Media Chiamate/Giorno
                        </div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB);">
                        <div class="value" id="active-leads">0</div>
                        <div class="label">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                                <path d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z"/>
                            </svg>
                            Lead Attivi
                        </div>
                    </div>
                </div>

                <!-- Pipeline Stats -->
                <div style="background: var(--bg-light); border-radius: 16px; padding: 20px; margin-bottom: 30px; border: 1px solid var(--border-light);">
                    <h3 style="color: var(--text-dark); margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z"/>
                        </svg>
                        Stato Pipeline
                    </h3>
                    <div id="pipeline-stats">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Export Actions -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <button class="btn-success" onclick="exportLeadOk()">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Esporta Lead Ok
                    </button>
                    <button class="btn-success" onclick="exportAllLeads()">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Esporta Tutti Lead
                    </button>
                    <button class="btn-success" onclick="exportActivityLog()">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Esporta Log Attività
                    </button>
                </div>

                <!-- Cleanup Section -->
                <div style="background: linear-gradient(135deg, #FFF8E1, #FFECB3); border-radius: 16px; padding: 20px; border: 1px solid #FFE082;">
                    <h3 style="color: #F57F17; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        Gestione Fine Mese
                    </h3>
                    <p style="color: #8D6E00; margin-bottom: 15px;">
                        Strumenti per archiviare i lead completati e preparare il sistema per il nuovo ciclo mensile.
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="btn-primary" onclick="showArchiveOptions()" style="background: linear-gradient(135deg, var(--status-non-risponde), #E8C080);">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                            </svg>
                            Archivia Lead Completati
                        </button>
                        <button class="btn-primary" onclick="showCleanupOptions()" style="background: linear-gradient(135deg, var(--status-non-interessato), #E5A5A5);">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Pulizia Sistema
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lead Detail Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-lead-name">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    Dettagli Lead
                </h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-lead-content">
                <!-- Lead details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Commercial Assignment Modal -->
    <div id="commercialModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Assegna Lead Ok
                </h2>
                <span class="close" onclick="closeCommercialModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p><strong>Lead recuperato con successo!</strong></p>
                <p id="commercial-lead-name" style="color: #27ae60; font-weight: bold; margin: 10px 0;"></p>
                <p style="color: var(--text-medium);">Scegli il commerciale a cui assegnare questo lead:</p>
            </div>
            
            <div class="form-group">
                <label>Commerciale:</label>
                <select id="commercial-select">
                    <option value="">Seleziona commerciale</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="confirmCommercialAssignment()" style="background: linear-gradient(135deg, var(--status-lead-ok), #9BD68C);">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 13l4 4L19 7"/>
                    </svg>
                    Assegna Lead
                </button>
                <button class="btn-primary" onclick="closeCommercialModal()" style="background: linear-gradient(135deg, var(--status-mai-reperibile), #C0C0C0);">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Archive Options Modal -->
    <div id="archiveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                    Archiviazione Lead Completati
                </h2>
                <span class="close" onclick="closeArchiveModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: var(--text-medium);">Seleziona quali lead completati vuoi archiviare per preparare il sistema al nuovo ciclo:</p>
            </div>
            
            <div id="archive-summary" style="background: var(--bg-light); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-light);">
                <!-- Summary will be populated -->
            </div>

            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px; color: var(--text-dark);">Opzioni di Archiviazione:</h4>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="archive-lead-ok" checked style="width: 18px; height: 18px;"> 
                    <span>Lead Ok (inviati ai commerciali)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="archive-non-interessato" checked style="width: 18px; height: 18px;"> 
                    <span>Non interessati</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="archive-mai-reperibile" checked style="width: 18px; height: 18px;"> 
                    <span>Mai reperibili</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="export-before-archive" checked style="width: 18px; height: 18px;"> 
                    <span>Esporta prima di archiviare</span>
                </label>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="executeArchive()" style="background: linear-gradient(135deg, var(--status-non-risponde), #E8C080);">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/>
                    </svg>
                    Conferma Archiviazione
                </button>
                <button class="btn-primary" onclick="closeArchiveModal()" style="background: linear-gradient(135deg, var(--status-mai-reperibile), #C0C0C0);">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Cleanup Options Modal -->
    <div id="cleanupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="#E57373" stroke-width="2">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Pulizia Sistema
                </h2>
                <span class="close" onclick="closeCleanupModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: #C62828; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    ATTENZIONE: Queste operazioni sono irreversibili!
                </p>
                <p style="color: var(--text-medium); margin-top: 10px;">Seleziona cosa vuoi eliminare definitivamente dal sistema:</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 15px; color: var(--text-dark);">Opzioni di Pulizia:</h4>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="cleanup-all-leads" style="width: 18px; height: 18px;"> 
                    <span>Elimina TUTTI i lead</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="cleanup-activity-log" style="width: 18px; height: 18px;"> 
                    <span>Pulisci log attività</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" id="export-before-cleanup" checked style="width: 18px; height: 18px;"> 
                    <span>Esporta tutto prima di eliminare</span>
                </label>
            </div>

            <div style="background: #FFF8E1; border: 1px solid #FFE082; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <p style="color: #8D6E00; display: flex; align-items: flex-start; gap: 10px;">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <strong>Consiglio:</strong> Esegui sempre un backup completo prima della pulizia. 
                    Dopo la pulizia potrai importare i nuovi lead del mese.
                </p>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="executeCleanup()" style="background: linear-gradient(135deg, var(--status-non-interessato), #E5A5A5);">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Conferma Pulizia
                </button>
                <button class="btn-primary" onclick="closeCleanupModal()" style="background: linear-gradient(135deg, var(--status-mai-reperibile), #C0C0C0);">
                    Annulla
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module">
        // Import Firebase functions
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD40Z7jsdHB0TOk6ZHdRndgJ0d_kYpMoV0",
            authDomain: "lead-recovery-urgenze.firebaseapp.com",
            projectId: "lead-recovery-urgenze",
            storageBucket: "lead-recovery-urgenze.firebasestorage.app",
            messagingSenderId: "462961230905",
            appId: "1:462961230905:web:a069852344f78eabe639e8"
        };
        // ============================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let leads = [];
        let currentFilter = 'tutti';
        let pendingImportData = null;
        let pendingLeadForCommercial = null;
        let isOnline = true;

        // ============================================
        // COMMERCIALI - MODIFICA QUI
        // ============================================
        const commerciali = [
            "Deidda",
            "Palmas", 
            "Poma",
            "Pesapane",
            "Congiu",
            "Mascia"
            "Serra"
        ];
        // ============================================

        // Status configurations with SVG icons
        const statusConfig = {
            'nuovo': { 
                label: 'Nuovo', 
                color: 'var(--status-nuovo)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            },
            'non-risponde': { 
                label: 'Non risponde', 
                color: 'var(--status-non-risponde)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>'
            },
            'non-risponde-2': { 
                label: 'Non risponde 2', 
                color: 'var(--status-non-risponde-2)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>'
            },
            'non-risponde-3': { 
                label: 'Non risponde 3', 
                color: 'var(--status-non-risponde-3)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>'
            },
            'mai-reperibile': { 
                label: 'Mai reperibile', 
                color: 'var(--status-mai-reperibile)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>'
            },
            'non-interessato': { 
                label: 'Non interessato', 
                color: 'var(--status-non-interessato)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>'
            },
            'lead-ok': { 
                label: 'Lead Ok', 
                color: 'var(--status-lead-ok)',
                icon: '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            }
        };

        // Populate commercial select
        function populateCommercialSelect() {
            const select = document.getElementById('commercial-select');
            select.innerHTML = '<option value="">Seleziona commerciale</option>';
            commerciali.forEach(comm => {
                const option = document.createElement('option');
                option.value = comm;
                option.textContent = comm;
                select.appendChild(option);
            });
        }

        // Initialize app
        async function initApp() {
            showLoading(true);
            populateCommercialSelect();
            
            try {
                const leadsQuery = query(collection(db, 'leads'), orderBy('dataCreazione', 'desc'));
                onSnapshot(leadsQuery, (snapshot) => {
                    leads = [];
                    snapshot.forEach((doc) => {
                        leads.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderPipeline();
                    renderLeads();
                    updateSyncStatus(true);
                    showLoading(false);
                }, (error) => {
                    console.error("Error listening to leads:", error);
                    updateSyncStatus(false);
                    showLoading(false);
                });

            } catch (error) {
                console.error("Error initializing app:", error);
                updateSyncStatus(false);
                showLoading(false);
            }
        }

        function updateSyncStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('sync-status');
            
            if (online) {
                statusEl.innerHTML = `
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Online - Sincronizzato
                `;
                statusEl.className = 'sync-status sync-online';
            } else {
                statusEl.innerHTML = `
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/>
                    </svg>
                    Offline - Non sincronizzato
                `;
                statusEl.className = 'sync-status sync-offline';
            }
        }

        function showLoading(show) {
            const loadingEl = document.getElementById('loading');
            if (show) {
                loadingEl.classList.add('show');
            } else {
                loadingEl.classList.remove('show');
            }
        }

        // Firebase operations
        async function addLeadToFirebase(leadData) {
            try {
                const docRef = await addDoc(collection(db, 'leads'), {
                    ...leadData,
                    dataCreazione: serverTimestamp(),
                    ultimaModifica: serverTimestamp()
                });
                return docRef.id;
            } catch (error) {
                console.error("Error adding lead: ", error);
                throw error;
            }
        }

        async function updateLeadInFirebase(leadId, updates) {
            try {
                const leadRef = doc(db, 'leads', leadId);
                await updateDoc(leadRef, {
                    ...updates,
                    ultimaModifica: serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating lead: ", error);
                throw error;
            }
        }

        async function deleteLeadFromFirebase(leadId) {
            try {
                await deleteDoc(doc(db, 'leads', leadId));
            } catch (error) {
                console.error("Error deleting lead: ", error);
                throw error;
            }
        }

        // UI Functions
        window.showTab = function(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.closest('.tab').classList.add('active');

            if (tabName === 'pipeline') {
                renderPipeline();
            } else if (tabName === 'dashboard') {
                renderLeads();
            } else if (tabName === 'reports') {
                renderReports();
            }
        };

        function renderPipeline() {
            const container = document.getElementById('pipeline-container');
            const statusKeys = Object.keys(statusConfig);
            
            container.innerHTML = statusKeys.map(status => {
                const leadsInStatus = leads.filter(lead => lead.stato === status);
                
                return `
                    <div class="pipeline-column ${status}" data-status="${status}" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
                        <div class="column-header">
                            ${statusConfig[status].icon}
                            ${statusConfig[status].label}
                            <div class="count">${leadsInStatus.length}</div>
                        </div>
                        <div class="column-content">
                            ${leadsInStatus.map(lead => `
                                <div class="pipeline-lead" draggable="true" data-lead-id="${lead.id}" ondragstart="drag(event)" onclick="showLeadDetail('${lead.id}')">
                                    <div class="lead-name">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                        </svg>
                                        ${lead.nome} ${lead.cognome}
                                    </div>
                                    <div class="lead-email">
                                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                        </svg>
                                        ${lead.email}
                                    </div>
                                    ${lead.commerciale ? `
                                        <div class="lead-commercial">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                            </svg>
                                            ${lead.commerciale}
                                        </div>
                                    ` : ''}
                                    <textarea class="lead-notes" placeholder="Note..." onchange="updateLeadNotes('${lead.id}', this.value)" onclick="event.stopPropagation()">${lead.note || ''}</textarea>
                                    ${lead.attivita && lead.attivita.length > 0 ? `
                                        <div class="auto-log">
                                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            Ultima: ${formatTimestamp(lead.attivita[lead.attivita.length - 1].timestamp)}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            updateStats();
        }

        function renderLeads() {
            const container = document.getElementById('leads-container');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filteredLeads = leads.filter(lead => {
                const matchesFilter = currentFilter === 'tutti' || lead.stato === currentFilter;
                const matchesSearch = searchTerm === '' || 
                    lead.nome.toLowerCase().includes(searchTerm) ||
                    lead.cognome.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm) ||
                    (lead.commerciale && lead.commerciale.toLowerCase().includes(searchTerm));
                
                return matchesFilter && matchesSearch;
            });

            container.innerHTML = filteredLeads.map(lead => `
                <div style="border: 1px solid var(--border-light); border-radius: 12px; padding: 18px; margin-bottom: 12px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <div style="font-weight: 600; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            ${lead.nome} ${lead.cognome}
                        </div>
                        <div style="padding: 6px 14px; border-radius: 20px; font-size: 0.8em; font-weight: 500; background: ${statusConfig[lead.stato].color}; display: flex; align-items: center; gap: 6px;">
                            ${statusConfig[lead.stato].icon}
                            ${statusConfig[lead.stato].label}
                        </div>
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-medium); margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            ${lead.email}
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            ${lead.telefono || 'N/D'}
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                            ${lead.commerciale || '<em>Non assegnato</em>'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 12px;">
                        <label style="font-size: 0.85em; color: var(--text-medium);">Assegna:</label>
                        <select onchange="assignCommercial('${lead.id}', this.value)" style="padding: 8px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 0.85em; flex: 1;">
                            <option value="">Seleziona commerciale</option>
                            ${commerciali.map(comm => `
                                <option value="${comm}" ${lead.commerciale === comm ? 'selected' : ''}>${comm}</option>
                            `).join('')}
                        </select>
                    </div>
                    <textarea style="width: 100%; padding: 10px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 0.9em; resize: vertical; min-height: 60px; font-family: inherit;" placeholder="Note per il commerciale..." onchange="updateLeadNotes('${lead.id}', this.value)">${lead.note || ''}</textarea>
                    <button onclick="showLeadDetail('${lead.id}')" class="btn-primary" style="margin-top: 12px; padding: 10px 20px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        Vedi Timeline
                    </button>
                </div>
            `).join('');

            updateStats();
        }

        function updateStats() {
            const today = new Date().toDateString();
            const todayActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => new Date(a.timestamp).toDateString() === today && a.azione === 'Chiamata effettuata')
            );
            
            document.getElementById('today-calls').textContent = todayActivities.length;
            document.getElementById('today-ok').textContent = todayActivities.filter(a => a.stato === 'lead-ok').length;
            document.getElementById('today-closed').textContent = todayActivities.filter(a => a.stato === 'non-interessato' || a.stato === 'mai-reperibile').length;
        }

        // Drag and drop functions
        window.allowDrop = function(ev) {
            ev.preventDefault();
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.add('drag-over');
            }
        };

        window.dragLeave = function(ev) {
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.remove('drag-over');
            }
        };

        window.drag = function(ev) {
            if (ev.target && ev.target.getAttribute) {
                const leadId = ev.target.getAttribute('data-lead-id');
                if (leadId && ev.dataTransfer) {
                    ev.dataTransfer.setData("text", leadId);
                    ev.target.classList.add('dragging');
                }
            }
        };

        window.drop = async function(ev) {
            ev.preventDefault();
            if (ev.currentTarget && ev.currentTarget.classList) {
                ev.currentTarget.classList.remove('drag-over');
            }
            
            if (ev.dataTransfer) {
                const leadId = ev.dataTransfer.getData("text");
                const newStatus = ev.currentTarget.getAttribute('data-status');
                const lead = leads.find(l => l.id === leadId);
                
                if (lead && lead.stato !== newStatus && newStatus) {
                    if (newStatus === 'lead-ok') {
                        pendingLeadForCommercial = { leadId: leadId, oldStatus: lead.stato, newStatus: newStatus };
                        showCommercialModal(lead);
                        
                        document.querySelectorAll('.pipeline-lead').forEach(el => {
                            if (el.classList) {
                                el.classList.remove('dragging');
                            }
                        });
                        return;
                    }
                    
                    await updateLeadStatus(leadId, newStatus);
                }
            }
            
            document.querySelectorAll('.pipeline-lead').forEach(el => {
                if (el.classList) {
                    el.classList.remove('dragging');
                }
            });
        };

        async function updateLeadStatus(leadId, newStatus) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    const now = new Date();
                    const dettagli = `Cambiato stato da "${statusConfig[lead.stato].label}" a "${statusConfig[newStatus].label}" - ${formatTime(now)}`;
                    
                    const newAttivita = (lead.attivita || []).concat([{
                        azione: 'Chiamata effettuata',
                        stato: newStatus,
                        timestamp: now.toISOString(),
                        automatico: true,
                        dettagli: dettagli
                    }]);
                    
                    await updateLeadInFirebase(leadId, {
                        stato: newStatus,
                        ultimaChiamata: now.toISOString(),
                        attivita: newAttivita
                    });
                    
                } catch (error) {
                    console.error('Error updating lead status:', error);
                    alert('Errore nell\'aggiornamento del lead. Riprova.');
                }
            }
        }

        function formatTime(date) {
            return date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'});
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return `${date.toLocaleDateString('it-IT')} ${date.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}`;
        }

        window.showLeadDetail = function(leadId) {
            const lead = leads.find(l => l.id === leadId);
            if (!lead) return;

            document.getElementById('modal-lead-name').innerHTML = `
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                ${lead.nome} ${lead.cognome}
            `;
            
            const modalContent = `
                <div style="margin-bottom: 20px;">
                    <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <strong>Email:</strong> ${lead.email}
                    </p>
                    <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                        </svg>
                        <strong>Telefono:</strong> ${lead.telefono || 'Non disponibile'}
                    </p>
                    <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        <strong>Commerciale:</strong> ${lead.commerciale || 'Non assegnato'}
                    </p>
                    <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <strong>Stato attuale:</strong> 
                        <span style="background: ${statusConfig[lead.stato].color}; padding: 4px 12px; border-radius: 15px; display: inline-flex; align-items: center; gap: 6px;">
                            ${statusConfig[lead.stato].icon}
                            ${statusConfig[lead.stato].label}
                        </span>
                    </p>
                    <p style="display: flex; align-items: flex-start; gap: 8px;">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-top: 2px;">
                            <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        <strong>Note:</strong> ${lead.note || 'Nessuna nota'}
                    </p>
                </div>
                
                <div class="timeline">
                    <h4 style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
                        </svg>
                        Timeline Attività
                    </h4>
                    ${(lead.attivita || []).slice().reverse().map(attivita => `
                        <div class="timeline-item" style="border-left-color: ${statusConfig[attivita.stato].color}">
                            <div class="timeline-time">
                                ${formatTimestamp(attivita.timestamp)}
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-action">${attivita.azione}</div>
                                <div style="color: var(--text-medium); font-size: 0.9em;">${attivita.dettagli}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('modal-lead-content').innerHTML = modalContent;
            document.getElementById('leadModal').style.display = 'block';
        };

        window.closeModal = function() {
            document.getElementById('leadModal').style.display = 'none';
        };

        // Commercial Assignment Modal Functions
        function showCommercialModal(lead) {
            document.getElementById('commercial-lead-name').textContent = `${lead.nome} ${lead.cognome} - ${lead.email}`;
            document.getElementById('commercial-select').value = lead.commerciale || '';
            document.getElementById('commercialModal').style.display = 'block';
        }

        window.closeCommercialModal = function() {
            document.getElementById('commercialModal').style.display = 'none';
            pendingLeadForCommercial = null;
        };

        window.confirmCommercialAssignment = async function() {
            const selectedCommercial = document.getElementById('commercial-select').value;
            
            if (!selectedCommercial) {
                alert('Seleziona un commerciale prima di procedere!');
                return;
            }

            if (pendingLeadForCommercial) {
                const lead = leads.find(l => l.id === pendingLeadForCommercial.leadId);
                if (lead) {
                    try {
                        const now = new Date();
                        const dettagli = `Lead recuperato con successo e assegnato a ${selectedCommercial} - ${formatTime(now)}`;
                        
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Lead recuperato',
                            stato: 'lead-ok',
                            timestamp: now.toISOString(),
                            automatico: true,
                            dettagli: dettagli
                        }]);
                        
                        await updateLeadInFirebase(pendingLeadForCommercial.leadId, {
                            commerciale: selectedCommercial,
                            stato: 'lead-ok',
                            ultimaChiamata: now.toISOString(),
                            attivita: newAttivita
                        });
                        
                        closeCommercialModal();
                        alert(`Lead "${lead.nome} ${lead.cognome}" assegnato con successo a ${selectedCommercial}!`);
                        
                    } catch (error) {
                        console.error('Error assigning commercial:', error);
                        alert('Errore nell\'assegnazione del commerciale. Riprova.');
                    }
                }
            }
        };

        window.updateLeadNotes = async function(leadId, notes) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    const updates = { note: notes };
                    
                    if (notes.trim()) {
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Nota aggiunta',
                            stato: lead.stato,
                            timestamp: new Date().toISOString(),
                            automatico: true,
                            dettagli: `Nota aggiunta: "${notes.substring(0, 50)}${notes.length > 50 ? '...' : ''}"`
                        }]);
                        
                        updates.attivita = newAttivita;
                    }
                    
                    await updateLeadInFirebase(leadId, updates);
                } catch (error) {
                    console.error('Error updating notes:', error);
                }
            }
        };

        window.assignCommercial = async function(leadId, commercial) {
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                try {
                    const oldCommercial = lead.commerciale;
                    const updates = { commerciale: commercial };
                    
                    if (commercial && commercial !== oldCommercial) {
                        const newAttivita = (lead.attivita || []).concat([{
                            azione: 'Commerciale assegnato',
                            stato: lead.stato,
                            timestamp: new Date().toISOString(),
                            automatico: true,
                            dettagli: `Commerciale assegnato: ${commercial}${oldCommercial ? ` (precedente: ${oldCommercial})` : ''}`
                        }]);
                        
                        updates.attivita = newAttivita;
                    }
                    
                    await updateLeadInFirebase(leadId, updates);
                } catch (error) {
                    console.error('Error assigning commercial:', error);
                }
            }
        };

        window.filterLeads = function(filter) {
            currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.filter-btn').classList.add('active');
            
            renderLeads();
        };

        window.addNewLead = async function() {
            try {
                const newLead = {
                    nome: document.getElementById('nome').value,
                    cognome: document.getElementById('cognome').value,
                    telefono: document.getElementById('telefono').value,
                    email: document.getElementById('email').value,
                    commerciale: '',
                    stato: 'nuovo',
                    note: '',
                    ultimaChiamata: null,
                    attivita: [{
                        azione: 'Creazione lead',
                        stato: 'nuovo',
                        timestamp: new Date().toISOString(),
                        automatico: true,
                        dettagli: 'Lead creato manualmente nel sistema'
                    }]
                };

                await addLeadToFirebase(newLead);
                document.getElementById('add-lead-form').reset();
                
            } catch (error) {
                console.error('Error adding lead:', error);
                alert('Errore nell\'aggiunta del lead. Riprova.');
            }
        };

        // File import functions 
        window.handleFileSelect = function(event) {
            const file = event.target.files[0];
            if (file) {
                processFile(file);
            }
        };

        function processFile(file) {
            const reader = new FileReader();
            const fileExtension = file.name.split('.').pop().toLowerCase();

            reader.onload = function(e) {
                try {
                    let data;
                    
                    if (fileExtension === 'csv') {
                        data = parseCSV(e.target.result);
                    } else if (fileExtension === 'xlsx' || fileExtension === 'xls') {
                        data = parseExcel(e.target.result);
                    } else {
                        showMessage('Formato file non supportato. Usa CSV, XLSX o XLS.', 'error');
                        return;
                    }

                    if (data && data.length > 0) {
                        showPreview(data);
                    } else {
                        showMessage('Nessun dato trovato nel file.', 'error');
                    }
                } catch (error) {
                    showMessage('Errore nella lettura del file: ' + error.message, 'error');
                }
            };

            if (fileExtension === 'csv') {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '').toLowerCase());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
                const row = {};
                
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                const mappedRow = {
                    nome: '',
                    cognome: '',
                    telefono: '',
                    email: ''
                };

                Object.keys(row).forEach(key => {
                    const cleanKey = key.toLowerCase().trim();
                    const value = row[key];
                    
                    if (cleanKey === 'nome' || cleanKey === 'name' || cleanKey === 'first') {
                        mappedRow.nome = value;
                    } else if (cleanKey === 'cognome' || cleanKey === 'surname' || cleanKey === 'last') {
                        mappedRow.cognome = value;
                    } else if (cleanKey === 'telefono' || cleanKey === 'phone' || cleanKey === 'tel') {
                        mappedRow.telefono = value;
                    } else if (cleanKey === 'email' || cleanKey === 'mail') {
                        mappedRow.email = value;
                    }
                });

                if (mappedRow.nome || mappedRow.cognome || mappedRow.email || mappedRow.telefono) {
                    data.push(mappedRow);
                }
            }

            return data;
        }

        function parseExcel(arrayBuffer) {
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);

            return jsonData.map(row => {
                const mappedRow = {
                    nome: '',
                    cognome: '',
                    telefono: '',
                    email: ''
                };

                Object.keys(row).forEach(originalKey => {
                    const cleanKey = originalKey.trim().toLowerCase();
                    const value = row[originalKey];
                    
                    if (cleanKey === 'nome') {
                        mappedRow.nome = value;
                    } else if (cleanKey === 'cognome') {
                        mappedRow.cognome = value;
                    } else if (cleanKey === 'telefono') {
                        mappedRow.telefono = value ? value.toString() : '';
                    } else if (cleanKey === 'email') {
                        mappedRow.email = value;
                    }
                });

                return mappedRow;
            }).filter(row => row.nome || row.cognome || row.email || row.telefono);
        }

        function showPreview(data) {
            pendingImportData = data;
            const previewContainer = document.getElementById('preview-container');
            const previewTable = document.getElementById('preview-table');

            const previewData = data.slice(0, 5);
            
            let tableHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid var(--border-light); border-radius: 8px;">
                        <thead>
                            <tr style="background: var(--bg-light);">
                                <th style="padding: 12px; border: 1px solid var(--border-light); text-align: left;">Nome</th>
                                <th style="padding: 12px; border: 1px solid var(--border-light); text-align: left;">Cognome</th>
                                <th style="padding: 12px; border: 1px solid var(--border-light); text-align: left;">Telefono</th>
                                <th style="padding: 12px; border: 1px solid var(--border-light); text-align: left;">Email</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            previewData.forEach(row => {
                tableHTML += `
                    <tr>
                        <td style="padding: 12px; border: 1px solid var(--border-light);">${row.nome || ''}</td>
                        <td style="padding: 12px; border: 1px solid var(--border-light);">${row.cognome || ''}</td>
                        <td style="padding: 12px; border: 1px solid var(--border-light);">${row.telefono || ''}</td>
                        <td style="padding: 12px; border: 1px solid var(--border-light);">${row.email || ''}</td>
                    </tr>
                `;
            });

            tableHTML += `
                        </tbody>
                    </table>
                </div>
                <p style="margin-top: 12px; color: var(--text-medium); font-size: 0.9em;">
                    Mostrati primi 5 record di ${data.length} totali.
                </p>
            `;

            previewTable.innerHTML = tableHTML;
            previewContainer.style.display = 'block';
        }

        window.confirmImport = async function() {
            if (pendingImportData && pendingImportData.length > 0) {
                showLoading(true);
                let importedCount = 0;
                
                try {
                    for (const row of pendingImportData) {
                        if (row.email && !leads.find(l => l.email === row.email)) {
                            const newLead = {
                                nome: row.nome || '',
                                cognome: row.cognome || '',
                                telefono: row.telefono || '',
                                email: row.email,
                                commerciale: '',
                                stato: 'nuovo',
                                note: '',
                                ultimaChiamata: null,
                                attivita: [{
                                    azione: 'Creazione lead',
                                    stato: 'nuovo',
                                    timestamp: new Date().toISOString(),
                                    automatico: true,
                                    dettagli: 'Lead importato da file CSV/Excel'
                                }]
                            };
                            
                            await addLeadToFirebase(newLead);
                            importedCount++;
                        }
                    }

                    showMessage(`Importati con successo ${importedCount} nuovi lead!`, 'success');
                    cancelImport();
                    
                } catch (error) {
                    console.error('Error importing leads:', error);
                    showMessage('Errore durante l\'importazione. Riprova.', 'error');
                } finally {
                    showLoading(false);
                }
            }
        };

        window.cancelImport = function() {
            pendingImportData = null;
            document.getElementById('preview-container').style.display = 'none';
            document.getElementById('file-input').value = '';
        };

        function showMessage(message, type) {
            const messagesContainer = document.getElementById('import-messages');
            const icon = type === 'error' ? 
                '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>' :
                '<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
            const messageClass = type === 'error' ? 'error-message' : 'success-message';
            
            messagesContainer.innerHTML = `<div class="${messageClass}">${icon} ${message}</div>`;
            
            setTimeout(() => {
                messagesContainer.innerHTML = '';
            }, 5000);
        }

        // Reports functions
        function renderReports() {
            const totalLeads = leads.length;
            const recoveredLeads = leads.filter(lead => lead.stato === 'lead-ok').length;
            const recoveryRate = totalLeads > 0 ? Math.round((recoveredLeads / totalLeads) * 100) : 0;
            const activeLeads = leads.filter(lead => !['lead-ok', 'non-interessato', 'mai-reperibile'].includes(lead.stato)).length;
            
            document.getElementById('total-leads').textContent = totalLeads;
            document.getElementById('recovery-rate-percent').textContent = recoveryRate + '%';
            document.getElementById('active-leads').textContent = activeLeads;
            
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).filter(a => a.azione === 'Chiamata effettuata')
            );
            const daysWithCalls = new Set(allActivities.map(a => new Date(a.timestamp).toDateString())).size;
            const avgDailyCalls = daysWithCalls > 0 ? Math.round(allActivities.length / daysWithCalls) : 0;
            document.getElementById('avg-daily-calls').textContent = avgDailyCalls;
            
            // Pipeline Stats
            const pipelineStatsContainer = document.getElementById('pipeline-stats');
            let pipelineHTML = '';
            Object.keys(statusConfig).forEach(status => {
                const count = leads.filter(lead => lead.stato === status).length;
                const percentage = totalLeads > 0 ? Math.round((count / totalLeads) * 100) : 0;
                pipelineHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; align-items: center;">
                            <span style="font-size: 0.9em; display: flex; align-items: center; gap: 6px;">
                                ${statusConfig[status].icon}
                                ${statusConfig[status].label}
                            </span>
                            <strong>${count} (${percentage}%)</strong>
                        </div>
                        <div style="background: var(--border-light); border-radius: 10px; height: 8px;">
                            <div style="background: ${statusConfig[status].color}; height: 8px; border-radius: 10px; width: ${percentage}%; transition: width 0.5s ease;"></div>
                        </div>
                    </div>
                `;
            });
            pipelineStatsContainer.innerHTML = pipelineHTML;
        }

        // Export functions
        window.exportLeadOk = function() {
            const leadOk = leads.filter(lead => lead.stato === 'lead-ok');
            const csv = 'Nome,Cognome,Telefono,Email,Commerciale,Note,Data Recupero\n' + 
                       leadOk.map(lead => {
                           const dataRecupero = (lead.attivita || []).find(a => a.stato === 'lead-ok')?.timestamp || '';
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${lead.commerciale || ''},"${lead.note || ''}",${new Date(dataRecupero).toLocaleDateString()}`;
                       }).join('\n');
            
            downloadCSV(csv, `lead-ok-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportAllLeads = function() {
            const csv = 'Nome,Cognome,Telefono,Email,Commerciale,Stato,Note,Data Creazione\n' + 
                       leads.map(lead => {
                           const dataCreazione = lead.dataCreazione?.seconds ? 
                               new Date(lead.dataCreazione.seconds * 1000).toLocaleDateString() : 
                               new Date(lead.dataCreazione).toLocaleDateString();
                           return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${lead.commerciale || ''},${lead.stato},"${lead.note || ''}",${dataCreazione}`;
                       }).join('\n');
            
            downloadCSV(csv, `tutti-lead-${new Date().toISOString().split('T')[0]}.csv`);
        };

        window.exportActivityLog = function() {
            const allActivities = leads.flatMap(lead => 
                (lead.attivita || []).map(activity => ({
                    ...activity,
                    leadName: `${lead.nome} ${lead.cognome}`,
                    leadEmail: lead.email
                }))
            );

            const csv = 'Data,Ora,Lead,Email,Azione,Stato,Dettagli\n' + 
                       allActivities.map(activity => {
                           const date = new Date(activity.timestamp);
                           return `${date.toLocaleDateString()},${date.toLocaleTimeString()},${activity.leadName},${activity.leadEmail},${activity.azione},${activity.stato},"${activity.dettagli}"`;
                       }).join('\n');
            
            downloadCSV(csv, `log-attivita-${new Date().toISOString().split('T')[0]}.csv`);
        };

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Archive and cleanup functions
        window.showArchiveOptions = function() {
            const leadOk = leads.filter(lead => lead.stato === 'lead-ok').length;
            const nonInteressato = leads.filter(lead => lead.stato === 'non-interessato').length;
            const maiReperibile = leads.filter(lead => lead.stato === 'mai-reperibile').length;
            const total = leadOk + nonInteressato + maiReperibile;

            document.getElementById('archive-summary').innerHTML = `
                <h4 style="margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Summary Lead da Archiviare:
                </h4>
                <p style="margin-bottom: 6px;">Lead Ok: <strong>${leadOk}</strong> (recuperati con successo)</p>
                <p style="margin-bottom: 6px;">Non interessati: <strong>${nonInteressato}</strong></p>
                <p style="margin-bottom: 6px;">Mai reperibili: <strong>${maiReperibile}</strong></p>
                <hr style="margin: 12px 0; border: none; border-top: 1px solid var(--border-light);">
                <p><strong>Totale da archiviare: ${total} lead</strong></p>
                <p style="color: #2E7D32;">Resteranno attivi: <strong>${leads.length - total} lead</strong></p>
            `;

            document.getElementById('archiveModal').style.display = 'block';
        };

        window.showCleanupOptions = function() {
            document.getElementById('cleanupModal').style.display = 'block';
        };

        window.closeArchiveModal = function() {
            document.getElementById('archiveModal').style.display = 'none';
        };

        window.closeCleanupModal = function() {
            document.getElementById('cleanupModal').style.display = 'none';
        };

        window.executeArchive = async function() {
            const archiveLeadOk = document.getElementById('archive-lead-ok').checked;
            const archiveNonInteressato = document.getElementById('archive-non-interessato').checked;
            const archiveMaiReperibile = document.getElementById('archive-mai-reperibile').checked;
            const exportFirst = document.getElementById('export-before-archive').checked;

            let toArchive = [];

            if (archiveLeadOk) {
                toArchive = toArchive.concat(leads.filter(lead => lead.stato === 'lead-ok'));
            }
            if (archiveNonInteressato) {
                toArchive = toArchive.concat(leads.filter(lead => lead.stato === 'non-interessato'));
            }
            if (archiveMaiReperibile) {
                toArchive = toArchive.concat(leads.filter(lead => lead.stato === 'mai-reperibile'));
            }

            if (toArchive.length === 0) {
                alert('Nessun lead selezionato per l\'archiviazione.');
                return;
            }

            const confirmMessage = `CONFERMA ARCHIVIAZIONE\n\nStai per archiviare ${toArchive.length} lead.\nQuesta operazione li rimuoverà dal sistema attivo.\n\nContinuare?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            showLoading(true);

            try {
                if (exportFirst && toArchive.length > 0) {
                    const csv = 'Nome,Cognome,Telefono,Email,Commerciale,Stato,Note,Data Creazione,Data Archiviazione\n' + 
                               toArchive.map(lead => {
                                   const dataCreazione = lead.dataCreazione?.seconds ? 
                                       new Date(lead.dataCreazione.seconds * 1000).toLocaleDateString() : 
                                       new Date(lead.dataCreazione).toLocaleDateString();
                                   return `${lead.nome},${lead.cognome},${lead.telefono || ''},${lead.email},${lead.commerciale || ''},${lead.stato},"${lead.note || ''}",${dataCreazione},${new Date().toLocaleDateString()}`;
                               }).join('\n');
                    
                    downloadCSV(csv, `lead-archiviati-${new Date().toISOString().split('T')[0]}.csv`);
                }

                for (const lead of toArchive) {
                    await deleteLeadFromFirebase(lead.id);
                }

                alert(`Archiviati con successo ${toArchive.length} lead!`);
                closeArchiveModal();
                
            } catch (error) {
                console.error('Error archiving leads:', error);
                alert('Errore durante l\'archiviazione. Riprova.');
            } finally {
                showLoading(false);
            }
        };

        window.executeCleanup = async function() {
            const cleanupAllLeads = document.getElementById('cleanup-all-leads').checked;
            const cleanupActivityLog = document.getElementById('cleanup-activity-log').checked;
            const exportFirst = document.getElementById('export-before-cleanup').checked;

            if (!cleanupAllLeads && !cleanupActivityLog) {
                alert('Seleziona almeno un\'opzione di pulizia.');
                return;
            }

            const confirmMessage = `ATTENZIONE PULIZIA SISTEMA!\n\nStai per eliminare:\n${cleanupAllLeads ? '- TUTTI i ' + leads.length + ' lead\n' : ''}${cleanupActivityLog ? '- Tutti i log di attività\n' : ''}\nQuesta operazione è IRREVERSIBILE!\n\nDigita "CONFERMA" per procedere:`;
            
            const userConfirm = prompt(confirmMessage);
            if (userConfirm !== 'CONFERMA') {
                alert('Operazione annullata.');
                return;
            }

            showLoading(true);

            try {
                if (exportFirst) {
                    if (cleanupAllLeads) {
                        exportAllLeads();
                        exportActivityLog();
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                if (cleanupAllLeads) {
                    for (const lead of leads) {
                        await deleteLeadFromFirebase(lead.id);
                    }
                    alert(`Eliminati ${leads.length} lead dal sistema!`);
                }

                if (cleanupActivityLog && !cleanupAllLeads) {
                    for (const lead of leads) {
                        const cleanedAttivita = [{
                            azione: 'Sistema ripulito',
                            stato: lead.stato,
                            timestamp: new Date().toISOString(),
                            automatico: true,
                            dettagli: 'Log precedenti eliminati durante pulizia mensile'
                        }];
                        
                        await updateLeadInFirebase(lead.id, {
                            attivita: cleanedAttivita
                        });
                    }
                    alert('Log attività puliti per tutti i lead!');
                }

                closeCleanupModal();
                
            } catch (error) {
                console.error('Error during cleanup:', error);
                alert('Errore durante la pulizia. Riprova.');
            } finally {
                showLoading(false);
            }
        };

        // Event listeners
        document.getElementById('add-lead-form').addEventListener('submit', function(e) {
            e.preventDefault();
            addNewLead();
        });

        document.getElementById('search-input').addEventListener('input', function() {
            renderLeads();
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            const leadModal = document.getElementById('leadModal');
            const commercialModal = document.getElementById('commercialModal');
            const archiveModal = document.getElementById('archiveModal');
            const cleanupModal = document.getElementById('cleanupModal');
            
            if (event.target == leadModal) {
                leadModal.style.display = "none";
            }
            if (event.target == commercialModal) {
                closeCommercialModal();
            }
            if (event.target == archiveModal) {
                archiveModal.style.display = "none";
            }
            if (event.target == cleanupModal) {
                cleanupModal.style.display = "none";
            }
        };

        // Drag and drop for file upload
        const importArea = document.getElementById('import-area');
        
        importArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            importArea.classList.add('dragover');
        });
        
        importArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            importArea.classList.remove('dragover');
        });
        
        importArea.addEventListener('drop', function(e) {
            e.preventDefault();
            importArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        // Initialize app when DOM is loaded
        initApp();
    </script>
</body>
</html>
